<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoDuel | The Table</title>
    <link rel="stylesheet" href="assets/css/tailwind.css"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="manifest" href="manifest.json"><script>if("serviceWorker" in navigator){navigator.serviceWorker.register("sw.js")}</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .serif { font-family: 'Playfair Display', serif; }

        .card-container {
            perspective: 1000px;
            width: 280px;
            height: 400px;
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
            cursor: default;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-back {
            /* Background color handled by utility classes */
            background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 20px 20px;
            color: white;
        }

        .card-front {
            background: white;
            transform: rotateY(180deg);
            color: #1e293b;
            text-align: center;
        }

        .symbol-pattern {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            opacity: 0.6;
            font-size: 1.5rem;
            color: white;
        }

        .timer-circle {
            transition: stroke-dashoffset 0.1s linear;
        }
    </style>
<script src="assets/js/audio.js"></script></head>
<body class="bg-gray-50 min-h-screen">

    <div class="fixed inset-0 flex flex-col md:flex-row">
        
        <!-- His Side -->
        <div id="his-area" class="absolute inset-0 flex flex-col items-center justify-center p-8 transition-all duration-500 bg-blue-50 z-10">
            <div class="absolute top-8 left-8 flex items-center gap-4 z-20">
                <div class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xl shadow-lg" id="his-score-disp">0</div>
                <div>
                    <p class="text-[10px] uppercase tracking-widest text-blue-600 font-bold" id="his-name-label">HIS NAME</p>
                    <p class="text-xs text-gray-400">Score</p>
                </div>
            </div>

            <div class="card-container mt-16" id="his-card-container">
                <div class="card" id="his-card">
                    <div class="card-face card-back shadow-2xl bg-blue-600 text-white">
                        <div class="symbol-pattern">
                            <span>△</span><span>▢</span>
                            <span>◯</span><span>✕</span>
                        </div>
                    </div>
                    <div class="card-face card-front shadow-2xl">
                        <p id="his-question" class="text-xl serif leading-relaxed"></p>
                        
                        <div class="mt-8 flex gap-4 justify-center items-start">
                            <div class="flex flex-col items-center gap-2">
                                <button id="his-answered" class="w-12 h-12 rounded-full border-2 bg-white border-green-100 text-green-600 flex items-center justify-center hover:bg-green-500 hover:text-white active:bg-green-600 active:text-white transition-all duration-200 text-xl shadow-sm">▢</button>
                                <span class="uppercase tracking-widest text-green-600/60 font-bold" style="font-size: 6px; line-height: 1;">Like</span>
                            </div>
                            
                            <div class="flex flex-col items-center gap-2">
                                <button id="his-joker" class="w-12 h-12 rounded-full border-2 bg-white border-yellow-100 text-yellow-500 flex items-center justify-center hover:bg-yellow-400 hover:text-white active:bg-yellow-500 active:text-white transition-all duration-200 text-xl shadow-sm">✨</button>
                                <span class="uppercase tracking-widest text-yellow-500/60 font-bold" style="font-size: 6px; line-height: 1;">Boon</span>
                            </div>

                            <div class="flex flex-col items-center gap-2">
                                <button id="his-pass" class="w-12 h-12 rounded-full border-2 bg-white border-red-100 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white active:bg-red-600 active:text-white transition-all duration-200 text-xl shadow-sm">✕</button>
                                <span class="uppercase tracking-widest text-red-500/60 font-bold" style="font-size: 6px; line-height: 1;">Dislike</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer (Hidden initially) -->
            <div id="his-timer-box" class="fixed bottom-8 left-8 opacity-0 transition-opacity z-30">
                <svg class="w-16 h-16 transform -rotate-90">
                    <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent" class="text-gray-200" />
                    <circle id="his-timer-circle" cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent" 
                        stroke-dasharray="175.9" stroke-dashoffset="0" class="text-blue-600 timer-circle" />
                </svg>
            </div>
        </div>

        <!-- Her Side -->
        <div id="her-area" class="absolute inset-0 flex flex-col items-center justify-center p-8 transition-all duration-500 bg-pink-50 z-0">
            <div class="absolute top-8 right-8 flex items-center gap-4 text-right flex-row-reverse z-20">
                <div class="w-12 h-12 rounded-full bg-pink-600 flex items-center justify-center text-white font-bold text-xl shadow-lg" id="her-score-disp">0</div>
                <div>
                    <p class="text-[10px] uppercase tracking-widest text-pink-600 font-bold" id="her-name-label">HER NAME</p>
                    <p class="text-xs text-gray-400">Score</p>
                </div>
            </div>

            <div class="card-container mt-16" id="her-card-container">
                <div class="card" id="her-card">
                    <div class="card-face card-back shadow-2xl bg-pink-600 text-white">
                        <div class="symbol-pattern">
                            <span>△</span><span>▢</span>
                            <span>◯</span><span>✕</span>
                        </div>
                    </div>
                    <div class="card-face card-front shadow-2xl">
                        <p id="her-question" class="text-xl serif leading-relaxed"></p>
                        
                        <div class="mt-8 flex gap-4 justify-center items-start">
                            <div class="flex flex-col items-center gap-2">
                                <button id="her-answered" class="w-12 h-12 rounded-full border-2 bg-white border-green-100 text-green-600 flex items-center justify-center hover:bg-green-500 hover:text-white active:bg-green-600 active:text-white transition-all duration-200 text-xl shadow-sm">▢</button>
                                <span class="uppercase tracking-widest text-green-600/60 font-bold" style="font-size: 6px; line-height: 1;">Like</span>
                            </div>
                            
                            <div class="flex flex-col items-center gap-2">
                                <button id="her-joker" class="w-12 h-12 rounded-full border-2 bg-white border-yellow-100 text-yellow-500 flex items-center justify-center hover:bg-yellow-400 hover:text-white active:bg-yellow-500 active:text-white transition-all duration-200 text-xl shadow-sm">✨</button>
                                <span class="uppercase tracking-widest text-yellow-500/60 font-bold" style="font-size: 6px; line-height: 1;">Boon</span>
                            </div>

                            <div class="flex flex-col items-center gap-2">
                                <button id="her-pass" class="w-12 h-12 rounded-full border-2 bg-white border-red-100 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white active:bg-red-600 active:text-white transition-all duration-200 text-xl shadow-sm">✕</button>
                                <span class="uppercase tracking-widest text-red-500/60 font-bold" style="font-size: 6px; line-height: 1;">Dislike</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer -->
            <div id="her-timer-box" class="fixed bottom-8 left-8 opacity-0 transition-opacity z-30">
                <svg class="w-16 h-16 transform -rotate-90">
                    <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent" class="text-gray-200" />
                    <circle id="her-timer-circle" cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent" 
                        stroke-dasharray="175.9" stroke-dashoffset="0" class="text-pink-600 timer-circle" />
                </svg>
            </div>
        </div>

    </div>

    <!-- Level Badge -->
    <div class="fixed bottom-8 right-8 bg-white px-6 py-2 rounded-full shadow-md border border-gray-100 z-30">
        <p class="text-[10px] text-center uppercase tracking-widest text-gray-400">Current Level</p>
        <p class="font-bold serif text-sm text-center" id="level-title">Acquaintance</p>
    </div>

    <script>
        let gameState = {
            hisScore: 0,
            herScore: 0,
            hisJokerUsed: false,
            herJokerUsed: false,
            currentTurn: localStorage.getItem('currentTurn') || 'his',
            questions: { his: [], her: [] },
            currentIndex: { his: 0, her: 0 },
            totalQuestions: 5, // We'll set this based on loaded cards
            timer: null,
            level: localStorage.getItem('selectedLevel') || 'acquaintance'
        };

        const hisName = localStorage.getItem('hisName') || 'Him';
        const herName = localStorage.getItem('herName') || 'Her';

        document.getElementById('his-name-label').textContent = hisName.toUpperCase();
        document.getElementById('her-name-label').textContent = herName.toUpperCase();
        document.getElementById('level-title').textContent = gameState.level.charAt(0).toUpperCase() + gameState.level.slice(1);

        async function initGame() {
            const response = await fetch('assets/json/cards.json');
            const data = await response.json();
            const levelCards = data[gameState.level];
            
            gameState.questions.his = shuffle(levelCards.male);
            gameState.questions.her = shuffle(levelCards.female);
            gameState.totalQuestions = Math.min(gameState.questions.his.length, gameState.questions.her.length);

            updateTurnUI();
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function updateTurnUI() {
            const hisArea = document.getElementById('his-area');
            const herArea = document.getElementById('her-area');
            const hisCard = document.getElementById('his-card');
            const herCard = document.getElementById('her-card');

            if (gameState.currentTurn === 'his') {
                // Show His Area, Hide Her Area
                hisArea.classList.remove('invisible', 'opacity-0', 'z-0');
                hisArea.classList.add('visible', 'opacity-100', 'z-10');
                
                herArea.classList.remove('visible', 'opacity-100', 'z-10');
                herArea.classList.add('invisible', 'opacity-0', 'z-0');

                hisCard.parentElement.classList.remove('pointer-events-none');
                herCard.parentElement.classList.add('pointer-events-none');
            } else {
                // Show Her Area, Hide His Area
                herArea.classList.remove('invisible', 'opacity-0', 'z-0');
                herArea.classList.add('visible', 'opacity-100', 'z-10');
                
                hisArea.classList.remove('visible', 'opacity-100', 'z-10');
                hisArea.classList.add('invisible', 'opacity-0', 'z-0');

                herCard.parentElement.classList.remove('pointer-events-none');
                hisCard.parentElement.classList.add('pointer-events-none');
            }
        }

        // Interaction Logic
        function handleFlip(side) {
            if (gameState.currentTurn !== side) return;
            
            const card = document.getElementById(`${side}-card`);
            const qText = document.getElementById(`${side}-question`);
            
            if (card.classList.contains('flipped')) return;

            SoundFX.flip(); // Play flip sound

            const questionData = gameState.questions[side][gameState.currentIndex[side]];
            
            // Handle both object and legacy string formats (just in case)
            const questionText = typeof questionData === 'object' ? questionData.text : questionData;
            const timerDuration = typeof questionData === 'object' ? questionData.timer : null;

            qText.textContent = questionText;
            card.classList.add('flipped');

            // Timer Logic: Check if this specific question has a timer
            if (timerDuration) {
                const timerBtn = document.createElement('button');
                timerBtn.id = `${side}-start-timer`;
                timerBtn.className = 'mt-4 px-4 py-1 bg-gray-200 text-gray-600 text-[10px] uppercase tracking-widest rounded-full hover:bg-gray-300 transition-all font-bold';
                timerBtn.textContent = `Start Timer (${timerDuration}s)`;
                timerBtn.onclick = (e) => {
                    e.stopPropagation();
                    timerBtn.remove();
                    SoundFX.click(); // Play click sound
                    startTimer(side, timerDuration);
                };
                card.querySelector('.card-front').appendChild(timerBtn);
            }

            // Joker Badge Logic
            const jokerBadge = document.createElement('div');
            if (!gameState[`${side}JokerUsed`]) {
                jokerBadge.className = 'absolute top-4 right-4 text-yellow-400 font-bold text-xl animate-pulse';
                jokerBadge.innerHTML = '✨';
                jokerBadge.title = "Boon Available";
                card.querySelector('.card-front').appendChild(jokerBadge);
            }
        }

        function playBeep() {
            // Replaced by SoundFX system, but keeping for timer end specific tone
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.value = 880; // A5
            gain.gain.value = 0.1;
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
            osc.stop(ctx.currentTime + 0.5);
        }

        function startTimer(side, duration) {
            const timerBox = document.getElementById(`${side}-timer-box`);
            const circle = document.getElementById(`${side}-timer-circle`);
            timerBox.classList.remove('opacity-0');
            
            let timeLeft = duration;
            const total = 175.9;
            
            gameState.timer = setInterval(() => {
                timeLeft -= 0.1;
                const offset = total - (timeLeft / duration) * total;
                circle.style.strokeDashoffset = offset;

                if (timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    playBeep();
                    alert("Time's up! Please select an action.");
                }
            }, 100);
        }

        function handleAction(side, type) {
            clearInterval(gameState.timer);
            document.getElementById(`${side}-timer-box`).classList.add('opacity-0');

            if (type === 'answered') {
                SoundFX.success(); // Play Like sound
                gameState[`${side}Score`]++;
                document.getElementById(`${side}-score-disp`).textContent = gameState[`${side}Score`];
            } else if (type === 'pass') {
                SoundFX.failure(); // Play Dislike sound
                gameState[`${side}Score`]--;
                document.getElementById(`${side}-score-disp`).textContent = gameState[`${side}Score`];
            } else if (type === 'joker') {
                SoundFX.joker(); // Play Joker sound
                gameState[`${side}JokerUsed`] = true;
                document.getElementById(`${side}-joker`).disabled = true;
                document.getElementById(`${side}-joker`).classList.add('opacity-20', 'cursor-not-allowed');
            }

            gameState.currentIndex[side]++;
            
            if (gameState.currentIndex.his >= gameState.totalQuestions && gameState.currentIndex.her >= gameState.totalQuestions) {
                endGame();
            }
            else {
                nextTurn();
            }
        }

        function nextTurn() {
            const side = gameState.currentTurn;
            const card = document.getElementById(`${side}-card`);
            
            // Reset card for next turn
            setTimeout(() => {
                card.classList.remove('flipped');
                gameState.currentTurn = (side === 'his' ? 'her' : 'his');
                updateTurnUI();
                
                // Clear any dynamically added badges if necessary (none currently)
            }, 600);
        }

        function endGame() {
            localStorage.setItem('finalScoreHis', gameState.hisScore);
            localStorage.setItem('finalScoreHer', gameState.herScore);
            window.location.href = 'results.html';
        }

        // Event Listeners
        document.getElementById('his-card').onclick = () => handleFlip('his');
        document.getElementById('her-card').onclick = () => handleFlip('her');

        document.getElementById('his-answered').onclick = (e) => { e.stopPropagation(); handleAction('his', 'answered'); };
        document.getElementById('his-joker').onclick = (e) => { e.stopPropagation(); handleAction('his', 'joker'); };
        document.getElementById('his-pass').onclick = (e) => { e.stopPropagation(); handleAction('his', 'pass'); };
        
        document.getElementById('her-answered').onclick = (e) => { e.stopPropagation(); handleAction('her', 'answered'); };
        document.getElementById('her-joker').onclick = (e) => { e.stopPropagation(); handleAction('her', 'joker'); };
        document.getElementById('her-pass').onclick = (e) => { e.stopPropagation(); handleAction('her', 'pass'); };

        initGame();
    </script>
</body>
</html>
